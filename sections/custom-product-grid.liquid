<section class="custom-grid">
  <div class="grid-container">
    {% for block in section.blocks %}
      {% assign product = all_products[block.settings.product] %}
      {% if product %}
        <div class="grid-item" data-handle="{{ product.handle }}">
          <img src="{{ product.featured_image | image_url: 'large' }}" alt="{{ product.title }}">
          <h3>{{ product.title }}</h3>
          <p>{{ product.price | money }}</p>
          <button class="quick-view" data-handle="{{ product.handle }}">View</button>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <!-- Popup -->
  <div id="product-popup" class="popup hidden">
    <div class="popup-content">
      <span class="close">&times;</span>
      <div id="popup-details"></div>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Custom Product Grid",
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select Product"
        }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Custom Product Grid",
      "category": "Products"
    }
  ]
}
{% endschema %}

{% javascript %}
  // Popup Logic
  document.querySelectorAll('.quick-view').forEach(btn => {
    btn.addEventListener('click', function() {
      let handle = this.getAttribute('data-handle');
      fetch(`/products/${handle}.js`)
        .then(res => res.json())
        .then(product => {
          let html = `
            <h2>${product.title}</h2>
            <p>${(product.price/100).toFixed(2)} ${Shopify.currency.active}</p>
            <p>${product.description}</p>
            <form id="add-to-cart-form">
              ${product.variants.map(v => `
                <label>
                  <input type="radio" name="variant" value="${v.id}" />
                  ${v.title}
                </label>
              `).join('')}
              <button type="submit">Add to Cart</button>
            </form>
          `;
          document.getElementById('popup-details').innerHTML = html;
          document.getElementById('product-popup').classList.remove('hidden');

          // Add to cart functionality
          document.getElementById('add-to-cart-form').addEventListener('submit', function(e){
            e.preventDefault();
            let variantId = this.variant.value;

            fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: variantId, quantity: 1 })
            })
            .then(() => {
              // special rule: if Black + Medium => add Soft Winter Jacket too
              let selectedVariant = product.variants.find(v => v.id == variantId);
              if (selectedVariant && selectedVariant.title.includes("Black") && selectedVariant.title.includes("Medium")) {
                let jacket = all_products['soft-winter-jacket'];
                if (jacket) {
                  fetch('/cart/add.js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: jacket.variants[0].id, quantity: 1 })
                  });
                }
              }
              alert("Added to cart!");
              document.getElementById('product-popup').classList.add('hidden');
            });
          });
        });
    });
  });

  // Close popup
  document.querySelector('.popup .close').addEventListener('click', () => {
    document.getElementById('product-popup').classList.add('hidden');
  });
{% endjavascript %}

{% stylesheet %}
.custom-grid {
  max-width: 1340px;
  margin: 0 auto;
  padding: 60px 20px;
}
.grid-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}
.grid-item {
  border: 1px solid #eee;
  text-align: center;
  padding: 10px;
}
.grid-item img {
  width: 100%;
  height: auto;
}
.grid-item h3 {
  font-family: 'Lustria', serif;
  font-size: 24px;
}
.popup {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
}
.popup.hidden { display: none; }
.popup-content {
  background: #fff;
  padding: 20px;
  width: 400px;
  max-width: 90%;
}
.popup .close {
  float: right;
  cursor: pointer;
  font-size: 20px;
}
{% endstylesheet %}
